{"version":3,"names":["_react","require","_reactNative","_livekitClient","_AudioSession","_interopRequireWildcard","_","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","useIOSAudioManagement","room","preferSpeakerOutput","onConfigureNativeAudio","localTrackCount","setLocalTrackCount","useState","remoteTrackCount","setRemoteTrackCount","trackState","useMemo","computeAudioTrackState","useEffect","recalculateTrackCounts","getLocalAudioTrackCount","getRemoteAudioTrackCount","on","RoomEvent","Connected","off","Platform","OS","onLocalPublished","onLocalUnpublished","log","warn","Math","max","onRemotePublished","onRemoteUnpublished","LocalTrackPublished","LocalTrackUnpublished","TrackPublished","TrackUnpublished","configFunc","getDefaultAppleAudioConfigurationForMode","audioConfig","AudioSession","setAppleAudioConfiguration","localTracks","remoteTracks","localParticipant","audioTrackPublications","size","audioTracks","remoteParticipants","forEach","participant"],"sources":["AudioManager.ts"],"sourcesContent":["import { useState, useEffect, useMemo } from 'react';\nimport { Platform } from 'react-native';\nimport { RoomEvent, Room } from 'livekit-client';\nimport AudioSession, {\n  getDefaultAppleAudioConfigurationForMode,\n  type AppleAudioConfiguration,\n  type AudioTrackState,\n} from './AudioSession';\nimport { log } from '..';\n\n/**\n * Handles setting the appropriate AVAudioSession options automatically\n * depending on the audio track states of the Room.\n *\n * @param room\n * @param preferSpeakerOutput\n * @param onConfigureNativeAudio A custom method for determining options used.\n */\nexport function useIOSAudioManagement(\n  room: Room,\n  preferSpeakerOutput: boolean = true,\n  onConfigureNativeAudio?: (\n    trackState: AudioTrackState,\n    preferSpeakerOutput: boolean\n  ) => AppleAudioConfiguration\n) {\n  const [localTrackCount, setLocalTrackCount] = useState(0);\n  const [remoteTrackCount, setRemoteTrackCount] = useState(0);\n  const trackState = useMemo(\n    () => computeAudioTrackState(localTrackCount, remoteTrackCount),\n    [localTrackCount, remoteTrackCount]\n  );\n\n  useEffect(() => {\n    let recalculateTrackCounts = () => {\n      setLocalTrackCount(getLocalAudioTrackCount(room));\n      setRemoteTrackCount(getRemoteAudioTrackCount(room));\n    };\n\n    recalculateTrackCounts();\n\n    room.on(RoomEvent.Connected, recalculateTrackCounts);\n\n    return () => {\n      room.off(RoomEvent.Connected, recalculateTrackCounts);\n    };\n  }, [room]);\n  useEffect(() => {\n    if (Platform.OS !== 'ios') {\n      return () => {};\n    }\n\n    let onLocalPublished = () => {\n      setLocalTrackCount(localTrackCount + 1);\n    };\n    let onLocalUnpublished = () => {\n      if (localTrackCount - 1 < 0) {\n        log.warn(\n          'mismatched local audio track count! attempted to reduce track count below zero.'\n        );\n      }\n      setLocalTrackCount(Math.max(localTrackCount - 1, 0));\n    };\n    let onRemotePublished = () => {\n      setRemoteTrackCount(remoteTrackCount + 1);\n    };\n    let onRemoteUnpublished = () => {\n      if (remoteTrackCount - 1 < 0) {\n        log.warn(\n          'mismatched remote audio track count! attempted to reduce track count below zero.'\n        );\n      }\n      setRemoteTrackCount(Math.max(remoteTrackCount - 1, 0));\n    };\n\n    room\n      .on(RoomEvent.LocalTrackPublished, onLocalPublished)\n      .on(RoomEvent.LocalTrackUnpublished, onLocalUnpublished)\n      .on(RoomEvent.TrackPublished, onRemotePublished)\n      .on(RoomEvent.TrackUnpublished, onRemoteUnpublished);\n\n    return () => {\n      room\n        .off(RoomEvent.LocalTrackPublished, onLocalPublished)\n        .off(RoomEvent.LocalTrackUnpublished, onLocalUnpublished)\n        .off(RoomEvent.TrackPublished, onRemotePublished)\n        .off(RoomEvent.TrackUnpublished, onRemoteUnpublished);\n    };\n  }, [room, localTrackCount, remoteTrackCount]);\n\n  useEffect(() => {\n    if (Platform.OS !== 'ios') {\n      return;\n    }\n\n    let configFunc =\n      onConfigureNativeAudio ?? getDefaultAppleAudioConfigurationForMode;\n    let audioConfig = configFunc(trackState, preferSpeakerOutput);\n    AudioSession.setAppleAudioConfiguration(audioConfig);\n  }, [trackState, onConfigureNativeAudio, preferSpeakerOutput]);\n}\n\nfunction computeAudioTrackState(\n  localTracks: number,\n  remoteTracks: number\n): AudioTrackState {\n  if (localTracks > 0 && remoteTracks > 0) {\n    return 'localAndRemote';\n  } else if (localTracks > 0 && remoteTracks === 0) {\n    return 'localOnly';\n  } else if (localTracks === 0 && remoteTracks > 0) {\n    return 'remoteOnly';\n  } else {\n    return 'none';\n  }\n}\n\nfunction getLocalAudioTrackCount(room: Room): number {\n  return room.localParticipant.audioTrackPublications.size;\n}\n\nfunction getRemoteAudioTrackCount(room: Room): number {\n  var audioTracks = 0;\n  room.remoteParticipants.forEach((participant) => {\n    audioTracks += participant.audioTrackPublications.size;\n  });\n\n  return audioTracks;\n}\n"],"mappings":"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","ignoreList":[]}