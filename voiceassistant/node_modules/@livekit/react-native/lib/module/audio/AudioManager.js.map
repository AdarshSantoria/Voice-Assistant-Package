{"version":3,"names":["useState","useEffect","useMemo","Platform","RoomEvent","AudioSession","getDefaultAppleAudioConfigurationForMode","log","useIOSAudioManagement","room","preferSpeakerOutput","onConfigureNativeAudio","localTrackCount","setLocalTrackCount","remoteTrackCount","setRemoteTrackCount","trackState","computeAudioTrackState","recalculateTrackCounts","getLocalAudioTrackCount","getRemoteAudioTrackCount","on","Connected","off","OS","onLocalPublished","onLocalUnpublished","warn","Math","max","onRemotePublished","onRemoteUnpublished","LocalTrackPublished","LocalTrackUnpublished","TrackPublished","TrackUnpublished","configFunc","audioConfig","setAppleAudioConfiguration","localTracks","remoteTracks","localParticipant","audioTrackPublications","size","audioTracks","remoteParticipants","forEach","participant"],"sources":["AudioManager.ts"],"sourcesContent":["import { useState, useEffect, useMemo } from 'react';\nimport { Platform } from 'react-native';\nimport { RoomEvent, Room } from 'livekit-client';\nimport AudioSession, {\n  getDefaultAppleAudioConfigurationForMode,\n  type AppleAudioConfiguration,\n  type AudioTrackState,\n} from './AudioSession';\nimport { log } from '..';\n\n/**\n * Handles setting the appropriate AVAudioSession options automatically\n * depending on the audio track states of the Room.\n *\n * @param room\n * @param preferSpeakerOutput\n * @param onConfigureNativeAudio A custom method for determining options used.\n */\nexport function useIOSAudioManagement(\n  room: Room,\n  preferSpeakerOutput: boolean = true,\n  onConfigureNativeAudio?: (\n    trackState: AudioTrackState,\n    preferSpeakerOutput: boolean\n  ) => AppleAudioConfiguration\n) {\n  const [localTrackCount, setLocalTrackCount] = useState(0);\n  const [remoteTrackCount, setRemoteTrackCount] = useState(0);\n  const trackState = useMemo(\n    () => computeAudioTrackState(localTrackCount, remoteTrackCount),\n    [localTrackCount, remoteTrackCount]\n  );\n\n  useEffect(() => {\n    let recalculateTrackCounts = () => {\n      setLocalTrackCount(getLocalAudioTrackCount(room));\n      setRemoteTrackCount(getRemoteAudioTrackCount(room));\n    };\n\n    recalculateTrackCounts();\n\n    room.on(RoomEvent.Connected, recalculateTrackCounts);\n\n    return () => {\n      room.off(RoomEvent.Connected, recalculateTrackCounts);\n    };\n  }, [room]);\n  useEffect(() => {\n    if (Platform.OS !== 'ios') {\n      return () => {};\n    }\n\n    let onLocalPublished = () => {\n      setLocalTrackCount(localTrackCount + 1);\n    };\n    let onLocalUnpublished = () => {\n      if (localTrackCount - 1 < 0) {\n        log.warn(\n          'mismatched local audio track count! attempted to reduce track count below zero.'\n        );\n      }\n      setLocalTrackCount(Math.max(localTrackCount - 1, 0));\n    };\n    let onRemotePublished = () => {\n      setRemoteTrackCount(remoteTrackCount + 1);\n    };\n    let onRemoteUnpublished = () => {\n      if (remoteTrackCount - 1 < 0) {\n        log.warn(\n          'mismatched remote audio track count! attempted to reduce track count below zero.'\n        );\n      }\n      setRemoteTrackCount(Math.max(remoteTrackCount - 1, 0));\n    };\n\n    room\n      .on(RoomEvent.LocalTrackPublished, onLocalPublished)\n      .on(RoomEvent.LocalTrackUnpublished, onLocalUnpublished)\n      .on(RoomEvent.TrackPublished, onRemotePublished)\n      .on(RoomEvent.TrackUnpublished, onRemoteUnpublished);\n\n    return () => {\n      room\n        .off(RoomEvent.LocalTrackPublished, onLocalPublished)\n        .off(RoomEvent.LocalTrackUnpublished, onLocalUnpublished)\n        .off(RoomEvent.TrackPublished, onRemotePublished)\n        .off(RoomEvent.TrackUnpublished, onRemoteUnpublished);\n    };\n  }, [room, localTrackCount, remoteTrackCount]);\n\n  useEffect(() => {\n    if (Platform.OS !== 'ios') {\n      return;\n    }\n\n    let configFunc =\n      onConfigureNativeAudio ?? getDefaultAppleAudioConfigurationForMode;\n    let audioConfig = configFunc(trackState, preferSpeakerOutput);\n    AudioSession.setAppleAudioConfiguration(audioConfig);\n  }, [trackState, onConfigureNativeAudio, preferSpeakerOutput]);\n}\n\nfunction computeAudioTrackState(\n  localTracks: number,\n  remoteTracks: number\n): AudioTrackState {\n  if (localTracks > 0 && remoteTracks > 0) {\n    return 'localAndRemote';\n  } else if (localTracks > 0 && remoteTracks === 0) {\n    return 'localOnly';\n  } else if (localTracks === 0 && remoteTracks > 0) {\n    return 'remoteOnly';\n  } else {\n    return 'none';\n  }\n}\n\nfunction getLocalAudioTrackCount(room: Room): number {\n  return room.localParticipant.audioTrackPublications.size;\n}\n\nfunction getRemoteAudioTrackCount(room: Room): number {\n  var audioTracks = 0;\n  room.remoteParticipants.forEach((participant) => {\n    audioTracks += participant.audioTrackPublications.size;\n  });\n\n  return audioTracks;\n}\n"],"mappings":"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","ignoreList":[]}